<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="LiftLab.Views.ProfilePage"
             xmlns:helper="clr-namespace:LiftLab.Helpers"
             xmlns:vm="clr-namespace:LiftLab.ViewModels"
             Title="Profile">

    <ContentPage.BindingContext>
        <vm:ProfileViewModel />
    </ContentPage.BindingContext>

    <Grid RowDefinitions="Auto,*" Padding="10">

        <!-- Top Row -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" VerticalOptions="Start" Padding="5">
            <!-- Settings -->
            <Label Grid.Column="0" FontFamily="FASolid" Text="{x:Static helper:FontAwesome.UserGear}" FontSize="35" TextColor="CornflowerBlue" IsVisible="{Binding UserProfile}">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding UpdateUserInfoCommand}" />
                </Label.GestureRecognizers>
            </Label>

            <!-- Profile Summary -->
            <VerticalStackLayout Grid.Column="1" HorizontalOptions="Center" Spacing="8">
                <Frame WidthRequest="120" HeightRequest="120" CornerRadius="80" BackgroundColor="Red" HasShadow="True" HorizontalOptions="Center">
                    <Label FontFamily="FASolid" Text="{x:Static helper:FontAwesome.UserAstronaut}" FontSize="56" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center"/>
                </Frame>
                <Label Text="{Binding Username}" FontAttributes="Bold" FontSize="24" TextColor="Black" HorizontalOptions="Center" />
                <BoxView HeightRequest="1" Color="Blue" HorizontalOptions="Fill" Margin="0,10,0,0" />
            </VerticalStackLayout>

            <!-- Logout -->
            <Label Grid.Column="2" FontFamily="FASolid" Text="{x:Static helper:FontAwesome.DoorClosed}" FontSize="35" TextColor="CornflowerBlue" IsVisible="{Binding UserProfile}" HorizontalOptions="End">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding LogOutCommand}" />
                </Label.GestureRecognizers>
            </Label>
        </Grid>

        <!-- Posts -->
        <StackLayout Grid.Row="1">
            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" />
            <CollectionView ItemsSource="{Binding UserPosts}" VerticalOptions="FillAndExpand">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Margin="5" Padding="0" HasShadow="True" CornerRadius="15" BackgroundColor="White">
                            <VerticalStackLayout>

                                <!-- Header -->
                                <Grid ColumnDefinitions="Auto,*,Auto,Auto" Padding="10,10,10,0">
                                    <Label Grid.Column="0" FontFamily="FASolid" Text="{x:Static helper:FontAwesome.UserAstronaut}" FontSize="18" VerticalOptions="Center" />
                                    <Label Grid.Column="1" Text="{Binding Username}" FontSize="20" FontAttributes="Bold" Margin="6,0,0,0" VerticalOptions="Center" />
                                    <Label Grid.Column="2" FontFamily="FASolid" Text="{x:Static helper:FontAwesome.Eye}" FontSize="18" TextColor="Blue">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProfileViewModel}}, Path=ShowPlanDetailsCommand}" CommandParameter="{Binding .}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                    <!-- Trash Icon -->
                                    <Label Grid.Column="3" FontFamily="FASolid" Text="{x:Static helper:FontAwesome.Trash}" FontSize="18" TextColor="Red" IsVisible="{Binding Source={RelativeSource AncestorType={x:Type vm:ProfileViewModel}}, Path=UserProfile}">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProfileViewModel}}, Path=DeletePostCommand}" CommandParameter="{Binding CommunityPostId}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                </Grid>

                                <BoxView HeightRequest="1" Color="Red" HorizontalOptions="Fill" Margin="10,5,10,0" />

                                <!-- Caption + Add Plan -->
                                <Grid ColumnDefinitions="*,Auto" Padding="10,5,10,10">
                                    <Label Grid.Column="0" Text="{Binding Caption}" FontSize="18" HorizontalOptions="StartAndExpand" />
                                    <Label Grid.Column="1" FontFamily="FASolid" Text="{x:Static helper:FontAwesome.Plus}" FontSize="18" TextColor="Blue">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProfileViewModel}}, Path=AddPlansToUserAccountCommand}" CommandParameter="{Binding .}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                </Grid>

                                <!-- Comments Icon + Count -->
                                <Grid ColumnDefinitions="Auto,Auto" Padding="10,0,10,10">
                                    <Label Grid.Column="0" FontFamily="FASolid" Text="{x:Static helper:FontAwesome.Comment}" FontSize="20" TextColor="Gray">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProfileViewModel}}, Path=ToggleCommentBoxCommand}" CommandParameter="{Binding .}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                    <Label Grid.Column="1" Text="{Binding Comments.Count}" FontSize="16" Margin="6,0,0,0" />
                                </Grid>

                                <!-- Comments Section -->
                                <StackLayout IsVisible="{Binding ShowCommentBox}" Padding="10,0">
                                    <CollectionView ItemsSource="{Binding Comments}" Margin="10,5,10,0">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate>
                                                <HorizontalStackLayout Padding="5,0" Spacing="10">
                                                    <Label FontFamily="FASolid" Text="{x:Static helper:FontAwesome.User}" FontSize="18" VerticalOptions="Start" />
                                                    <VerticalStackLayout>
                                                        <Label Text="{Binding Username}" FontAttributes="Bold" FontSize="14" />
                                                        <Label Text="{Binding Comment}" FontSize="12" />
                                                    </VerticalStackLayout>
                                                </HorizontalStackLayout>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                    <!-- Add Comment -->
                                    <HorizontalStackLayout Padding="10" Spacing="10">
                                        <Entry Placeholder="Enter a comment..." Text="{Binding CommentText}" HorizontalOptions="FillAndExpand" FontSize="14" />
                                        <Label FontFamily="FASolid" Text="{x:Static helper:FontAwesome.Plus}" FontSize="22" TextColor="Blue">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ProfileViewModel}}, Path=CreateCommentCommand}" CommandParameter="{Binding .}" />
                                            </Label.GestureRecognizers>
                                        </Label>
                                    </HorizontalStackLayout>
                                </StackLayout>

                            </VerticalStackLayout>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </StackLayout>
    </Grid>
</ContentPage>